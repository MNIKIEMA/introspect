(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[769],{4635:(e,t,r)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/reports",function(){return r(301)}])},6389:(e,t,r)=>{"use strict";r.d(t,{A:()=>n});var a=r(5105),s=r(9035),l=r.n(s);let n=()=>(0,a.jsxs)(l(),{children:[(0,a.jsx)("title",{children:"Defog.ai - AI Assistant for Data Analysis"}),(0,a.jsx)("meta",{name:"description",content:"Train your AI data assistant on your own device"}),(0,a.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1"}),(0,a.jsx)("link",{rel:"icon",href:"/favicon.ico"})]})},3360:(e,t,r)=>{"use strict";r.d(t,{A:()=>d});var a=r(5105),s=r(8101),l=r(3472),n=r(5379),o=r(6159),i=r(4799);let d=e=>{let{id:t,userType:r,children:d,rootClassNames:c="",contentClassNames:m="max-h-full h-full",containerClassNames:u="flex flex-col md:min-h-screen relative container mx-auto"}=e,[x,h]=(0,s.useState)([]),g=(0,l.useRouter)(),j=e=>{g.push(e)},p=()=>{localStorage.removeItem("defogUser"),localStorage.removeItem("defogToken"),localStorage.removeItem("defogUserType"),j("/log-in")},f=(0,o.usePathname)();return(0,s.useEffect)(()=>{h(("admin"==r?[{title:"Admin",href:"#!",children:[{key:"manage-database",title:"Manage Database",href:"/extract-metadata"},{key:"manage-users",title:"Manage Users",href:"/manage-users"},{key:"align-model",title:"Align Model",href:"/align-model"},{key:"evaluate-model",title:"Evaluate Model",href:"/evaluate-model"}]},{key:"query-data",title:"Query Data",href:"/query-data"},{key:"reports",title:"Reports",href:"/reports"},{key:"logout",classNames:"self-end",title:"Logout",href:"#",onClick:p}]:r?[{key:"query-data",title:"Query Data",href:"/query-data"},{key:"reports",title:"Reports",href:"/reports"},{key:"logout",classNames:"self-end",title:"Logout",href:"#",onClick:p}]:[]).map(e=>(e.current=e.href==f,e)).map(e=>(e.children&&(e.children=e.children.map(e=>(e.current=e.href==f,e))),e)))},[r]),(0,a.jsxs)("div",{className:(0,i.QP)(u,c),children:[x.length?(0,a.jsx)(n.jq,{rootClassNames:(0,i.QP)("border-b dark:border-dark-border","bg-white dark:bg-dark-bg-primary","text-primary-text dark:text-dark-text-primary"),items:x.map(e=>({...e,classNames:(0,i.QP)(e.classNames,"hover:bg-gray-100 dark:hover:bg-dark-hover",e.current&&"bg-gray-100 dark:bg-dark-hover")}))}):(0,a.jsx)(a.Fragment,{}),(0,a.jsx)("div",{className:m,children:d})]})}},301:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>E});var a=r(5105),s=r(8101),l=r(7547),n=r(6572);let o=(0,l.c)("Command",[["path",{d:"M15 6v12a3 3 0 1 0 3-3H6a3 3 0 1 0 3 3V6a3 3 0 1 0-3 3h12a3 3 0 1 0-3-3",key:"11bfej"}]]),i=(0,l.c)("MessageSquare",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]]),d=(0,l.c)("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]),c=({clarification:e,options:t,input_type:r,onAnswerChange:a,onDismiss:n})=>{let o=(0,s.useMemo)(()=>{switch(r){case"single_choice":return l.j.jsx(l.S,{label:e,options:t.map(e=>({label:e,value:e})),onChange:a});case"multiple_choice":return l.j.jsx(l.M,{label:e,options:t.map(e=>({label:e,value:e})),onChange:a});default:return l.j.jsx(l.T,{label:e,onChange:e=>a(e.target.value)})}},[]);return l.j.jsxs("div",{className:"relative",children:[n&&l.j.jsx("button",{onClick:n,className:"absolute -right-2 -top-2 p-1 rounded-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors",title:"Dismiss",children:l.j.jsx(l.X,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"})}),o]})},m=({source:e,onSelected:t})=>l.j.jsxs("div",{className:`relative flex h-[79px] w-full items-center gap-2.5 rounded-lg border border-gray-200 dark:border-gray-700 px-1.5 py-1 hover:border-gray-50 dark:hover:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-700 ${e.selected?"bg-gray-100 dark:bg-gray-700 ":"bg-white dark:bg-gray-800 opacity-70"}`,children:[l.j.jsxs("a",{href:e.link,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 z-10","aria-label":`Visit ${e.title}`,children:[l.j.jsx("span",{className:"shrink-0",children:l.j.jsx("img",{src:`https://www.google.com/s2/favicons?domain=${e.link}&sz=128`,alt:e.link,className:"rounded-full p-1",width:36,height:36})}),l.j.jsxs("span",{className:"flex min-w-0 max-w-[192px] flex-col justify-center gap-1",children:[l.j.jsx("h6",{className:"line-clamp-2 text-xs font-light",children:e.title}),l.j.jsx("span",{className:"truncate text-xs font-light text-[#1B1B16]/30 dark:text-gray-400",children:e.link})]})]}),l.j.jsx("div",{className:"ml-2 mr-2 cursor-pointer relative z-20",onClick:e=>{e.stopPropagation(),t()},children:e.selected?l.j.jsx(l.C,{className:"w-3 text-green-500 dark:text-green-400"}):l.j.jsx(d,{className:"w-3 text-gray-500 hover:text-gray-600 dark:text-gray-400 dark:hover:text-gray-300 stroke-2"})})]});function u({apiEndpoint:e,dbName:t,token:r,onReportGenerated:a}){var i;let[d,u]=(0,s.useState)({}),[x,h]=(0,s.useState)(!1),[g,j]=(0,s.useState)(!1),[p,f]=(0,s.useState)(""),y=(0,s.useRef)(""),b=(0,s.useRef)(null);(0,s.useEffect)(()=>{j(navigator.userAgent.toLowerCase().includes("mac"))},[]);let v=(0,s.useContext)(l.a),k=(0,s.useCallback)(async()=>{var s,l;try{h(!0),y.current="Submitting report for generation...";try{await (0,n.g)(e,r,t,p,(null==(s=b.current)?void 0:s.value)||d.userQuestion,d.sources.filter(e=>e.selected).map(e=>e.link),d.clarifications.filter(e=>e.answer&&e.is_answered))}catch{v.success("Report submitted for generation")}a((null==(l=b.current)?void 0:l.value)||d.userQuestion,p,n.O.THINKING),u({}),y.current="",b.current.value=""}catch(e){v.error("Error generating report:",e)}finally{h(!1)}h(!1)},[d]);return l.j.jsx("div",{className:"h-full overflow-auto py-4 px-1 lg:px-10",children:l.j.jsxs("div",{className:"flex flex-col items-start justify-center min-h-full m-auto",children:[l.j.jsx(l.T,{ref:b,rootClassNames:"w-full",textAreaClassNames:"rounded-xl dark:bg-gray-800 dark:text-gray-200 dark:border-gray-700",suffix:l.j.jsxs("span",{className:"flex items-center dark:text-gray-400",children:["Press"," ",g?l.j.jsxs(l.j.Fragment,{children:[l.j.jsx(o,{className:"inline w-2.5 mx-1"})," + Enter"]}):"Ctrl + Enter"," ","to start"]}),disabled:x,label:l.j.jsx("div",{className:"text-lg dark:text-gray-200",children:"What would you like a report on?"}),placeholder:"Type here",autoResize:!0,defaultRows:1,textAreaHtmlProps:{style:{resize:"none"}},onKeyDown:async a=>{if("Enter"===a.key&&(a.metaKey||a.ctrlKey)){let s=a.currentTarget.value;try{h(!0),y.current="Analyzing database and thinking if I need to ask clarifying questions. This can take 15-20 seconds...",u(e=>({...e,userQuestion:s}));let{clarifications:a,report_id:l}=await (0,n.a)(e,r,t,s);console.log("clarifications",a),f(l),u(e=>({...e,clarifications:a,sources:[]}))}catch{v.error("Error getting clarifications")}finally{h(!1)}}}}),!x&&d.clarifications&&l.j.jsxs("div",{className:"my-4 max-w-2xl",children:[l.j.jsx("div",{className:"font-light mb-2 dark:text-gray-300",children:"Add Details & Sources"}),l.j.jsxs("div",{className:"space-y-6",children:[(null==(i=d.sources)?void 0:i.length)>0&&l.j.jsxs("div",{className:"space-y-2",children:[l.j.jsx("div",{className:"font-light text-sm dark:text-gray-400",children:"Sources"}),l.j.jsx("div",{className:"bg-white dark:bg-gray-800 flex w-full flex-col pl-1 rounded-lg",children:l.j.jsx("div",{className:"flex w-full items-center overflow-x-scroll gap-6 pb-3",children:d.sources.map((e,t)=>l.j.jsx(m,{source:e,onSelected:()=>{let e=d.sources.slice();e[t].selected=!e[t].selected,u(t=>({...t,sources:e}))}},t))})})]}),l.j.jsxs("div",{className:"space-y-2",children:[l.j.jsx("div",{className:"font-light text-sm dark:text-gray-400",children:"Details"}),d.clarifications.map((e,t)=>(0,s.createElement)(c,{...e,key:t+e.clarification,onAnswerChange:e=>{u(r=>({...r,clarifications:r.clarifications.map((r,a)=>a===t?{...r,answer:e,is_answered:!!e&&("string"==typeof e?!!e:e.length>0)}:r)}))},onDismiss:()=>{u(e=>({...e,clarifications:e.clarifications.filter((e,r)=>r!==t)}))}}))]}),l.j.jsx(l.B,{className:"bg-gray-600 text-white border-0 hover:bg-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600",onClick:k,children:x?y.current:"Generate"})]})]}),x&&l.j.jsxs("div",{className:"w-full text-sm text-gray-400 dark:text-gray-500 relative flex items-start rounded-xl",children:[l.j.jsx(l.b,{}),y.current]})]})})}let x=({apiEndpoint:e,token:t,onDbCreated:r=(...e)=>{}})=>{let a=(0,s.useContext)(l.a),[n,o]=(0,s.useState)(!1);return console.log(n),l.j.jsxs("div",{className:"min-w-full min-h-full",children:[l.j.jsx(l.D,{disabled:n,rootClassNames:(0,l.t)(n?"hidden":""),acceptedFileTypes:Object.values(l.F),showIcon:!0,onFileSelect:async s=>{o(!0),s.preventDefault(),s.stopPropagation();try{let n=s.target.files[0];if(!n||!(0,l.i)(n.type))throw Error("Only CSV or Excel files are accepted");let i=await n.arrayBuffer();if("text/csv"===n.type)try{let{dbName:s}=await (0,l.u)(e,t,n.name,(0,l.d)(i)).catch(e=>{throw e});a.success(`DB ${s} created successfully`),r(s)}catch(e){throw o(!1),e}else try{let{dbName:s}=await (0,l.u)(e,t,n.name,(0,l.d)(i)).catch(e=>{throw e});a.success(`DB ${s} created successfully`),r(s)}catch(e){throw o(!1),e}}catch(e){console.error(e),a.error("Failed to parse the file")}},onDrop:async s=>{var n,i;o(!0),s.preventDefault(),s.stopPropagation();try{let d=null==(i=null==(n=null==s?void 0:s.dataTransfer)?void 0:n.items)?void 0:i[0];if(!d||!d.kind||"file"!==d.kind)throw Error("Invalid file");if(!(0,l.i)(d.type))throw Error("Only CSV or Excel files are accepted");let c=d.getAsFile(),m=performance.now(),u=await c.arrayBuffer();if("text/csv"===c.type)try{let{dbName:s}=await (0,l.u)(e,t,c.name,(0,l.d)(u)).catch(e=>{throw e}),n=performance.now();console.log(`CSV upload took ${n-m}ms`),a.success(`DB ${s} created successfully`),r(s)}catch(e){throw o(!1),e}else try{let{dbName:s}=await (0,l.u)(e,t,c.name,(0,l.d)(u));a.success(`DB ${s} created successfully`),r(s)}catch(e){throw o(!1),e}}catch(e){a.error(e.message||"Failed to parse the file"),console.log(e.stack)}}}),n&&l.j.jsxs("div",{className:"text-xs flex w-full h-full items-center justify-center gap-1",children:[l.j.jsx(l.b,{})," Uploading your file"]})]})};function h({step:e}){let{function_name:t,result:r}=e;r||(r={});let{question:a,sql:s,columns:o=[],rows:i="[]",error:d="",df_truncated:c=!1}=r,m=d||(o&&o.length?"":"No results"),u=[];if(i&&!d)try{u=JSON.parse(i)}catch(e){console.error("Failed to parse rows JSON:",e),m="Failed to parse rows JSON"}return l.j.jsxs("div",{className:"border p-4 rounded-md shadow-sm bg-white dark:bg-dark-bg-secondary dark:border-dark-border max-h-[600px] overflow-y-auto",children:[l.j.jsxs("h2",{className:"text-lg font-semibold mb-2 text-gray-800 dark:text-dark-text-primary",children:["Function: ",l.j.jsx("span",{className:"font-normal",children:t})]}),a&&l.j.jsxs("p",{className:"mb-2 text-gray-700 dark:text-dark-text-secondary",children:[l.j.jsx("strong",{className:"text-gray-800 dark:text-dark-text-primary",children:"Question:"})," ",a]}),m?l.j.jsxs("div",{className:"text-red-600 bg-red-100 p-3 rounded-md dark:bg-red-900/20 dark:text-red-400 dark:border dark:border-red-800",children:[l.j.jsx("strong",{children:"Error:"})," ",m]}):l.j.jsx(l.e,{tabs:[{name:"Results",content:l.j.jsxs("div",{className:"relative",children:[c&&l.j.jsx("div",{className:"text-sm bg-yellow-50 p-2 rounded mb-2 border border-yellow-200 text-yellow-700 dark:bg-yellow-900/20 dark:text-yellow-400 dark:border-yellow-800",children:"Note: Results have been truncated"}),l.j.jsx(l.f,{columns:o.map(e=>({dataIndex:e,title:e})),rows:u})]})},{name:"SQL",content:l.j.jsx(n.C,{code:s||"",language:"sql",editable:!1})}],defaultSelected:"Results"})]})}function g({step:e}){let{function_name:t,result:r}=e,a;a="string"==typeof r?r:JSON.stringify(r);let s=(0,n.s)(n.m.parse(a),{allowedTags:n.s.defaults.allowedTags.concat(["img"]),allowedAttributes:{...n.s.defaults.allowedAttributes,img:["src","alt","title"]}});return l.j.jsxs("div",{className:"border p-4 rounded-md shadow-sm bg-white dark:bg-dark-bg-secondary dark:border-dark-border max-h-[600px] overflow-y-auto",children:[l.j.jsxs("h2",{className:"text-lg font-semibold mb-2 text-gray-800 dark:text-dark-text-primary",children:["Function: ",l.j.jsx("span",{className:"font-normal",children:t})]}),l.j.jsx("div",{className:"text-gray-700 dark:text-dark-text-secondary prose dark:prose-invert prose-sm max-w-none",dangerouslySetInnerHTML:{__html:s}})]})}let j=`

------

`;function p({apiEndpoint:e,token:t,reportId:r,onStreamClosed:a=()=>{},onDelete:n=()=>{}}){let[o,i]=(0,s.useState)([]),[d,c]=(0,s.useState)(!1),m=(0,s.useRef)(o);m.current=o;let u=(0,s.useContext)(l.a);return(0,s.useEffect)(()=>{let s=!1,l=new AbortController,n=(e,t=!1)=>{l.abort(),null==e||e.releaseLock(),c(!0),a(m.current,t)};return async function(){var a;try{let s=await fetch(`${e}/oracle/get_report_thinking_status?report_id=${r}`,{headers:{"X-Auth-Token":t},signal:l.signal});if(!s.ok){console.error("Stream request failed:",s.status),c(!0);return}let o=null==(a=s.body)?void 0:a.getReader();if(!o){console.error("No reader found on response body."),c(!0);return}let d=new TextDecoder("utf-8"),m="";for(;;){let{done:e,value:t}=await o.read();if(e){console.log("Stream ended from server.");break}let r=[];for(let e of(m+=d.decode(t,{stream:!0})).split(j)){let t=e.replace("data:","").trim();if(t){if("Stream closed without errors"===t){console.log("[Stream Event] 'Stream closed' received."),n(o);return}if("Stream closed with errors"===t){n(o,!0);return}try{let e=JSON.parse(t);if(e.error){u.error("Could not generate report. Error: "+e.error),n(o,!0);return}Array.isArray(e)?r.push(...e):r.push(e)}catch(e){console.warn("Failed to parse SSE data:",e)}}}i(r)}c(!0)}catch(e){s||console.error("[Stream Error]",e),c(!0)}}(),()=>{s=!0,l.abort()}},[e,t,r]),l.j.jsxs("div",{className:"relative p-2",children:[l.j.jsxs("div",{className:"flex flex-row w-full items-center mb-4 mt-4",children:[l.j.jsx("h1",{className:"text-xl font-bold grow dark:text-dark-text-primary",children:"Details"}),l.j.jsx(l.B,{variant:"danger",className:"self-end",onClick:n,children:"Delete"})]}),!d&&l.j.jsxs("div",{className:"w-full h-40 bg-white dark:bg-gray-800 rounded-md border flex items-center justify-center gap-2",children:[l.j.jsx(l.b,{classNames:"w-5 h-5 text-blue-500 animate-spin"}),l.j.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Creating SQL queries and searching the web to answer your question. I will show my thinking below. The report will automatically load when I am done thinking."})]}),l.j.jsx("div",{className:"w-full",children:o.filter(e=>{var t;return!("object"==typeof e.result&&null!=(t=e.result)&&t.error)}).map(e=>l.j.jsx("div",{className:"w-full md:w-1/2 p-2 inline-block align-top transition-all duration-500 ease-in-out",children:"text_to_sql_tool"===e.function_name&&"db_name"in e.inputs?l.j.jsx(h,{step:e}):l.j.jsx(g,{step:e})},e.id))})]})}let f=(e,t,r)=>{if(!r[e])return"Today";for(let a of Object.keys(r[e]))if(r[e][a].some(e=>e.report_id===t))return a;return"Today"};function y({apiEndpoint:e,token:t,initialDbNames:r=[]}){let[a,o]=(0,s.useState)(r),[i,d]=(0,s.useState)("Default DB"),[c,m]=(0,s.useState)({}),[h,g]=(0,s.useState)(!0),[j,y]=(0,s.useState)(null),[v,k]=(0,s.useState)(null),w=(0,s.useMemo)(()=>v?c[i][f(i,v,c)].find(e=>e.report_id===v):null,[v,c,i]),N=(0,s.useRef)((0,l.g)()),{current:S}=(0,s.useRef)(crypto.randomUUID().toString());(0,s.useEffect)(()=>{!async function(){try{let r={};d(a.length?a[0]:S);let s=new Date,l=new Date(s);l.setDate(l.getDate()-1);let o=new Date(s);o.setDate(o.getDate()-7);let i=new Date(s);for(let d of(i.setMonth(i.getMonth()-1),a)){r[d]={Today:[],Yesterday:[],"Past week":[],"Past month":[],Earlier:[]};try{let a=await (0,n.f)(e,t,d);if(!a)throw Error("Failed to get reports");a.filter(e=>e.status!==n.O.ERRORED&&e.status!==n.O.INITIALIZED).forEach(e=>{let t=new Date(e.date_created);t.toDateString()===s.toDateString()?r[d].Today.push(e):t.toDateString()===l.toDateString()?r[d].Yesterday.push(e):t>=o?r[d]["Past week"].push(e):t>=i?r[d]["Past month"].push(e):r[d].Earlier.push(e)}),Object.entries(r[d]).forEach(([e,t])=>{t.sort((e,t)=>new Date(e.date_created).getTime()-new Date(t.date_created).getTime())})}catch{y("Failed to fetch reports for db name "+d);break}}m(r)}catch(e){y(e.message)}finally{g(!1)}}()},[]);let C=(0,s.useCallback)(async()=>{let r=f(i,v,c);if(await (0,n.d)(e,v,t,i))N.current.success("Report deleted"),m(e=>{let t=e[i][r].filter(e=>e.report_id!==v),a={...e,[i]:{...e[i],[r]:t}};return 0===t.length&&delete a[i][r],a}),k(null);else{N.current.error("Failed to delete report");return}},[e,t,v,i]),E=(0,s.useMemo)(()=>l.j.jsx(l.S,{label:"Select Database",rootClassNames:"mb-2",value:i,allowClear:!1,allowCreateNewOption:!1,options:[{value:S,label:"Upload new"}].concat(a.map(e=>({value:e,label:e}))),onChange:e=>{d(e),k(null)}}),[i,a]);return j?l.j.jsxs("div",{className:"w-screen h-screen flex items-center justify-center bg-rose-50 text-rose-500",children:["Error: ",j]}):h?l.j.jsxs("div",{className:"w-screen h-screen flex items-center justify-center bg-gray-50 text-gray-400",children:[l.j.jsx(l.b,{})," ",l.j.jsx("span",{children:"Loading"})]}):l.j.jsxs(l.a.Provider,{value:N.current,children:[l.j.jsx(l.h,{rootClassNames:"absolute left-0 right-0"}),l.j.jsxs("div",{className:"flex flex-row min-w-full min-h-full max-h-full overflow-hidden text-gray-600 bg-white dark:bg-gray-900",children:[l.j.jsx(l.k,{open:!0,beforeTitle:E,location:"left",rootClassNames:"absolute left-0 min-h-full shadow-2xl lg:shadow-none lg:sticky top-0 bg-gray-50 z-20",title:l.j.jsx("span",{className:"font-bold",children:"History"}),contentClassNames:"w-72 p-4 rounded-tl-lg relative sm:block min-h-96 max-h-full overflow-auto",children:l.j.jsxs("div",{className:"space-y-4",children:[i!==S?l.j.jsx("div",{className:(0,l.t)("title hover:cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 history-item p-2 text-sm",v?"":"font-medium bg-gray-100 dark:bg-gray-800 border-l-2 border-l-blue-500"),onClick:()=>k(null),children:l.j.jsxs("div",{className:"flex flex-row items-center gap-2",children:[l.j.jsx(n.S,{})," ",l.j.jsx("span",{children:"New"})]})}):l.j.jsx("p",{className:"text-xs",children:"Upload a new CSV/Excel file on the right"}),i!==S&&Object.entries(c[i]).map(([e,t])=>0===Object.keys(t).length?null:l.j.jsxs("div",{className:"mb-6",children:[l.j.jsx("div",{className:"px-2 mb-2 text-xs font-medium tracking-wide text-blue-400 uppercase",children:e}),t.map(e=>l.j.jsx("div",{onClick:()=>{k(e.report_id)},className:(0,l.t)("title hover:cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 history-item p-2 text-sm",e.report_id===v?"font-bold bg-gray-100 dark:bg-gray-800 border-l-2 border-l-blue-500":""),children:e.report_name||e.inputs.user_question||"Untitled report"},e.report_id))]},e))]})}),l.j.jsxs("div",{className:"flex flex-col grow p-2 overflow-auto",children:[null===v&&i===S&&l.j.jsx(x,{apiEndpoint:e,token:t,onDbCreated:e=>{m(t=>({...t,[e]:{Today:[],Yesterday:[],"Past week":[],"Past month":[],Earlier:[]}})),o(t=>[...t,e]),d(e)}}),v&&w&&w.status===n.O.DONE?l.j.jsx(b,{reportId:v,apiEndpoint:e,dbName:i,token:t,onDelete:C,onReportParsed:e=>{let t=f(i,v,c);m(r=>{let a=r[i][t];return{...r,[i]:{...r[i],[t]:a.map(t=>t.report_id===v?{...t,reportData:e}:t)}}})}},v):v&&l.j.jsx(p,{apiEndpoint:e,token:t,reportId:v,onDelete:C,onStreamClosed:(e,t)=>{let r=f(i,v,c);t?(m(e=>{let t={...e};return t[i][r]=t[i][r].filter(e=>e.report_id!==v),t}),k(null)):m(e=>{let t={...e};return t[i][r]=t[i][r].map(e=>e.report_id===v?{...e,status:n.O.DONE}:e),t})}}),a.map(r=>l.j.jsx("div",{className:(0,l.t)("w-full h-full m-auto",v||i!==r?"hidden":""),children:l.j.jsx(u,{token:t,dbName:r,apiEndpoint:e,onReportGenerated:(e,t,a)=>{m(s=>(console.log(s[r].Today),{...s,[r]:{...s[r],Today:[{report_id:t,report_name:e,status:a,date_created:(0,n.o)()},...s[r].Today||[]]}})),k(t)}})},r))]})]})]})}function b({apiEndpoint:e,reportId:t,dbName:r,token:a,onReportParsed:o=()=>{},onDelete:i=()=>{}}){let[d,c]=(0,s.useState)({}),[m,u]=(0,s.useState)([]),[x,h]=(0,s.useState)([]),[g,j]=(0,s.useState)(null),[p,f]=(0,s.useState)(null),[y,b]=(0,s.useState)(!0),[v,w]=(0,s.useState)(0),[N,S]=(0,s.useState)("table");if((0,s.useEffect)(()=>{t&&r&&(async(t,r)=>{try{let s;b(!0),(s=await (0,n.j)(e,t,r,a)).parsed.mdx&&j(s.parsed.mdx),s.parsed.tables&&c(s.parsed.tables),s.analyses&&u(s.analyses),s.comments&&h(s.comments),o&&o(s)}catch(e){console.error(e),f(e.message)}finally{b(!1)}})(t,r)},[t,r]),y)return l.j.jsx("div",{className:"w-full h-full min-h-60 flex flex-col justify-center items-center text-center rounded-md p-2 bg-white dark:bg-gray-800",children:l.j.jsxs("div",{className:"mb-2 text-sm text-gray-400 dark:text-gray-200",children:[l.j.jsx(l.b,{classNames:"w-5 h-5"}),"Loading"]})});if(p)return l.j.jsx("div",{className:"w-full h-full min-h-60 flex flex-col justify-center items-center bg-rose-100 dark:bg-rose-900 text-red text-center rounded-md p-2",children:l.j.jsx("div",{className:"mb-2 text-sm text-rose-500 dark:text-rose-400",children:p})});let C=m.filter(e=>""===e.error),E=C[v]||null;return l.j.jsx(n.b.Provider,{value:{apiEndpoint:e,tables:d,multiTables:{},images:{},analyses:m,executiveSummary:null,reportId:t,dbName:r,token:a,commentManager:(0,n.c)({apiEndpoint:e,reportId:t,dbName:r,token:a,initialComments:x})},children:l.j.jsxs("div",{className:"flex gap-4 relative",children:[l.j.jsx("div",{className:"flex-1 relative oracle-report-ctr",children:l.j.jsx(n.E,{extensions:n.e,content:g,immediatelyRender:!1,editable:!1,slotBefore:l.j.jsx(k,{onDelete:i}),editorProps:{attributes:{class:"max-w-4xl oracle-report-tiptap relative prose prose-base dark:prose-invert mx-auto py-2 px-10 mb-12 md:mb-0 focus:outline-none *:cursor-default"}}})}),C.length>0&&l.j.jsxs("div",{className:"w-[600px] 2xl:w-[800px] sticky top-4 self-start max-h-[calc(100vh-2rem)] flex flex-col border dark:border-gray-700 rounded-lg overflow-hidden bg-white dark:bg-gray-800",children:[l.j.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 border-b dark:border-gray-700",children:[l.j.jsx("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:"Analysis Results"}),l.j.jsxs("div",{className:"flex items-center space-x-2",children:[l.j.jsx("button",{onClick:()=>S("table"),className:`px-3 py-1 text-xs font-medium rounded-md transition-colors ${"table"===N?"bg-primary-highlight text-gray-200 dark:bg-blue-600 dark:text-white":"bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 border dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700"}`,children:"Table"}),l.j.jsx("button",{onClick:()=>S("chart"),className:`px-3 py-1 text-xs font-medium rounded-md transition-colors ${"chart"===N?"bg-primary-highlight text-gray-200 dark:bg-blue-600 dark:text-white":"bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 border dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700"}`,children:"Chart"})]})]}),l.j.jsxs("div",{className:"flex flex-1 min-h-0 overflow-hidden",children:[l.j.jsx("div",{className:"w-[250px] border-r dark:border-gray-700 overflow-y-auto bg-white dark:bg-gray-800",children:C.map((e,t)=>l.j.jsx("button",{onClick:()=>w(t),className:`w-full text-left p-3 border-b dark:border-gray-700 text-sm ${v===t?"bg-gray-100 dark:bg-gray-700 font-medium text-gray-900 dark:text-gray-100 h-auto":"bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"}`,children:l.j.jsx("div",{className:`overflow-hidden transition-all duration-300 ${v===t?"max-h-[500px]":"max-h-[4.5rem] hover:max-h-[500px]"}`,children:l.j.jsx("p",{className:`${v===t?"line-clamp-none":"line-clamp-3 hover:line-clamp-none"}`,children:e.question})})},t))}),l.j.jsx("div",{className:"w-full overflow-auto p-3 bg-white dark:bg-gray-800",children:E&&l.j.jsx(l.j.Fragment,{children:"table"===N?l.j.jsx(l.f,{columns:E.columns,rows:E.rows,columnHeaderClassNames:"py-2",skipColumns:["index"]}):l.j.jsx(n.h,{children:l.j.jsx(n.i,{rows:E.rows,columns:E.columns,initialQuestion:E.question,initialOptionsExpanded:!1},`chart-${v}`)})})})]})]})]})})}function v({onClose:e}){let{commentManager:t}=(0,s.useContext)(n.b),r=(0,s.useSyncExternalStore)((null==t?void 0:t.subscribeToCommentUpdates)||(()=>()=>{}),(null==t?void 0:t.getComments)||(()=>[]));return l.j.jsxs("div",{className:"w-64 h-full flex flex-col",children:[l.j.jsx("div",{className:"h-[3.5rem] invisible"}),l.j.jsxs("div",{className:"flex-1 border-l border-gray-200 dark:border-gray-700 overflow-y-auto bg-white dark:bg-gray-800 shadow-lg",children:[l.j.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:l.j.jsxs("div",{className:"flex items-center justify-between",children:[l.j.jsxs("div",{className:"flex items-center gap-2",children:[l.j.jsx(i,{className:"w-5 h-5"}),l.j.jsx("h2",{className:"text-lg font-semibold",children:"Comments"}),l.j.jsxs("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:["(",r.length,")"]})]}),l.j.jsx(l.B,{variant:"secondary",onClick:e,className:"hover:bg-gray-100 dark:hover:bg-gray-700 p-1",children:l.j.jsx(l.X,{className:"w-5 h-5"})})]})}),l.j.jsx("div",{className:"p-4",children:0===r.length?l.j.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"No comments yet"}):l.j.jsx("div",{className:"space-y-4",children:r.map(e=>l.j.jsxs("div",{className:"p-3 rounded-lg bg-gray-50 dark:bg-gray-700",children:[e.user&&l.j.jsx("div",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:e.user}),l.j.jsx("div",{className:(0,l.t)("text-sm text-gray-600 dark:text-gray-300",!e.content&&"text-gray-300"),children:e.content||"Blank comment"})]},e.id))})})]})]})}let k=({onDelete:e=()=>{}})=>{let[t,r]=(0,s.useState)(!1),[a,o]=(0,s.useState)(!1),d=(0,s.useContext)(l.a),{apiEndpoint:c,reportId:m,dbName:u,token:x,commentManager:h}=(0,s.useContext)(n.b),g=(0,s.useRef)(null),j=(0,s.useSyncExternalStore)((null==h?void 0:h.subscribeToCommentUpdates)||(()=>()=>{}),(null==h?void 0:h.getComments)||(()=>[])),{editor:p}=(0,n.u)(),f=(0,s.useRef)({});(0,s.useEffect)(()=>{if(j&&j.length>0){let e={};j.forEach(t=>{e[t.id]={id:t.id,commentContent:t.content,user:t.user,htmlSnippet:"",commentRelevantText:t.content}}),f.current=e}},[j]);let y=null==status?void 0:status.startsWith("Revision in progress"),b=()=>{f.current={};let e=null==p?void 0:p.state.doc;e&&(e.nodesBetween(0,e.content.size,(e,t,r)=>{var a;for(let r of e.marks)if("comment"===r.type.name){let s=t+e.textContent.length,l=r.attrs.commentId,n=j.find(e=>e.id===l);if(!n)continue;let o=!1,i=0,d=e,c=t;for(;!o&&i<10&&d;){p.commands.setNodeSelection(c);let e=p.state.selection.$from.parent;"doc"===e.type.name?o=!0:(d=e,c=null==(a=p.state.selection)?void 0:a.from),p.commands.selectParentNode(),i++}f.current[l]?(f.current[l].topParent=d,f.current[l].topParentPos=c,t<f.current[l].startPos&&(f.current[l].startPos=t),s>f.current[l].endPos&&(f.current[l].endPos=s)):f.current[l]={id:l,topParent:d,topParentPos:c,htmlSnippet:"",commentContent:n.content,commentRelevantText:"",startPos:t,endPos:s,user:n.user}}return!0}),Object.values(f.current).forEach(e=>{let t="",r=(t="text"===e.topParent.type.name?"<span class='oracle-report-comment' data-comment-id='temp'>"+e.topParent.textContent+"</span>":"recommendationTitle"===e.topParent.type.name?"## <span class='oracle-report-comment' data-comment-id='temp'>"+e.topParent.textContent+"</span>":'<span class="oracle-report-comment" data-comment-id="temp">'+p.storage.markdown.serializer.serialize(e.topParent)+"</span>").replace(/<span[^>]*>/g,"").replace(/<\/span>/g,"");e.commentRelevantText=r,e.htmlSnippet=t}))},[k,w]=(0,s.useState)(!1);return p?l.j.jsxs("div",{className:"flex flex-col",children:[l.j.jsxs("div",{className:"flex items-center flex-row-reverse justify-between px-4 py-2 border-b dark:border-gray-700",children:[l.j.jsxs("div",{className:"relative",children:[l.j.jsx(l.B,{variant:"secondary",onClick:()=>{b(),o(!a)},className:a?"bg-gray-100 dark:bg-gray-700":"",children:l.j.jsx(i,{className:"w-5 h-5"})}),j.length>0&&l.j.jsx("div",{className:"absolute -top-1 -right-1 bg-blue-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center",children:j.length})]}),l.j.jsx(l.B,{variant:"danger",onClick:()=>w(!0),children:"Delete"}),l.j.jsx(l.l,{open:k,onOk:()=>{e(m,u),w(!1)},onCancel:()=>w(!1),okText:"Yes",okVariant:"danger",children:"Are you sure?"})]}),y&&l.j.jsxs("div",{className:"w-96 my-4 rounded-full border dark:border-none mx-auto bg-gray-50 dark:bg-gray-600 text-sm text-gray-600 dark:text-gray-300 p-4 flex flex-row shadow-md items-center",children:[l.j.jsx(l.I,{className:"min-w-6 mr-2 text-blue-500 dark:text-blue-400"}),l.j.jsx("p",{children:"This report is currently being revised. This page will refresh when the revision completes."})]}),a&&l.j.jsx("div",{className:"fixed right-0 top-0 bottom-0 z-[100]",children:l.j.jsx(v,{onClose:()=>o(!1)})}),status&&l.j.jsx("div",{className:`fixed bottom-6 ${a?"right-72":"right-6"} z-[110] transition-all duration-200`,children:l.j.jsx(l.B,{variant:"primary",onClick:()=>{b(),r(!0)},disabled:!status||y,className:"shadow-lg hover:shadow-xl transition-shadow",children:"Submit for revision"})}),l.j.jsx(l.l,{rootClassNames:"w-full z-10",open:t,onCancel:()=>r(!1),onOk:()=>{var e;try{(0,n.k)(c,m,u,x,null==(e=g.current)?void 0:e.value,j.map(e=>({relevant_text:e.content,comment_text:e.content}))).then(e=>{r(!1)}).catch(e=>{console.error(e),d.error(e.message)})}catch(e){d.error(e.message)}},title:"Revise report",okText:"Submit",className:"dark:bg-gray-800 dark:text-gray-200",contentClassNames:"overflow-auto",children:l.j.jsxs("div",{className:"flex flex-row flex-wrap gap-4",children:[Object.values(f.current).map((e,t)=>l.j.jsxs("div",{className:"revise-modal-comment-container w-full",children:[l.j.jsx("div",{className:"revise-modal-header",children:"Highlighted text"}),l.j.jsx(n.E,{content:e.htmlSnippet,extensions:n.r,immediatelyRender:!1,editable:!1,editorProps:{attributes:{class:"revise-modal-highlight prose prose-sm dark:prose-invert focus:outline-none *:cursor-default"}}}),l.j.jsx("div",{className:"revise-modal-header",children:"Your comment"}),l.j.jsx("textarea",{className:"text-sm revise-modal-comment-text w-full h-full focus:ring-0 border-none outline-none",defaultValue:e.commentContent,placeholder:"Type your comment here",onChange:t=>{f.current[e.id].commentContent=t.target.value,null==h||h.updateComments(p,Object.values(f.current).map(e=>({id:e.id,content:e.commentContent,user:e.user})))}})]},e.id)),l.j.jsxs("div",{className:"w-full revise-modal-comment-container overflow-hidden",children:[l.j.jsx("div",{className:"revise-modal-header",children:"General comments"}),l.j.jsx(l.T,{autoResize:!0,placeholder:"Add general comments here",rootClassNames:"border-none",textAreaClassNames:"rounded-none ring-0",ref:g,textAreaHtmlProps:{resize:"none"}})]})]})})]}):null};var w=r(3360),N=r(6389),S=r(5379),C=r(3184);function E(){let[e,t]=(0,s.useState)(""),[r,l]=(0,s.useState)(""),[n,o]=(0,s.useState)([]),[i,d]=(0,s.useState)(!0),c=async()=>{let e=localStorage.getItem("defogToken"),t=await fetch((C.env.NEXT_PUBLIC_AGENTS_ENDPOINT||"")+"/get_db_names",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})});if(!t.ok)throw Error("Failed to get api key names - are you sure your network is working?");o((await t.json()).db_names),d(!1)};return(0,s.useEffect)(()=>{let e=localStorage.getItem("defogToken");l(localStorage.getItem("defogUserType")),t(e),c(),e&&t(e)},[]),!0===i?(0,a.jsx)(S.c5,{}):(0,a.jsxs)("div",{className:"h-screen",children:[(0,a.jsx)(N.A,{}),(0,a.jsx)(w.A,{id:"query-data",userType:r,containerClassNames:"max-h-screen h-screen flex flex-col",contentClassNames:"h-full max-h-full",children:(0,a.jsx)(y,{apiEndpoint:C.env.NEXT_PUBLIC_AGENTS_ENDPOINT||"",token:e,initialDbNames:n})})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[600,328,429,636,593,792],()=>t(4635)),_N_E=e.O()}]);