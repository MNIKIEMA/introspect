# builds image for the agents backend
FROM python:3.10

WORKDIR agents-python-server

ARG GOOGLE_APPLICATION_CREDENTIALS_PATH


# copy supervisor conf
COPY ./agents-backend/docker-setup-files/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# copy google creds
COPY $GOOGLE_APPLICATION_CREDENTIALS_PATH /cloud-storage-creds.json

# copy startup script
COPY ./agents-backend/docker-setup-files/startup.sh /startup.sh

# need cmake for scikit
RUN apt-get update && apt-get install -y python3-pip cmake supervisor


COPY ./agents-backend/agents/requirements.txt ./requirements.txt
# install requirements
RUN pip install -r requirements.txt

# expose python server port
EXPOSE 1235

ENV GOOGLE_APPLICATION_CREDENTIALS=/cloud-storage-creds.json

COPY ./agents-backend/agents/ ./

# create empty report assets dirs
RUN mkdir -p /agents-assets/report-assets
RUN mkdir -p /agents-assets/report-assets/boxplots 
RUN mkdir -p /agents-assets/report-assets/datasets 
RUN mkdir -p /agents-assets/report-assets/heatmaps 
RUN mkdir -p /agents-assets/report-assets/kaplan-meier-plots 
RUN mkdir -p /agents-assets/report-assets/linechart 
RUN mkdir -p /agents-assets/report-assets/linecharts

# copy supervisor startup conf
COPY ./agents-backend/docker-setup-files/start.conf /etc/supervisor/conf.d/start.conf


# start startup script
CMD ["/bin/bash", "/startup.sh"]
